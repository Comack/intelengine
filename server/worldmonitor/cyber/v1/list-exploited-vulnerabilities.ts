import type {
  ServerContext,
  ListExploitedVulnerabilitiesRequest,
  ListExploitedVulnerabilitiesResponse,
  ExploitedVulnerability,
} from '../../../../src/generated/server/worldmonitor/cyber/v1/service_server';

const KEV_URL = 'https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json';

export async function listExploitedVulnerabilities(
  _ctx: ServerContext,
  req: ListExploitedVulnerabilitiesRequest,
): Promise<ListExploitedVulnerabilitiesResponse> {
  const limit = req.limit && req.limit > 0 ? req.limit : 100;
  
  try {
    const response = await fetch(KEV_URL);
    if (!response.ok) {
      throw new Error(`Failed to fetch KEV catalog: ${response.statusText}`);
    }

    const data = await response.json();
    const vulnerabilities = data?.vulnerabilities || [];

    // Sort by dateAdded descending
    vulnerabilities.sort((a: any, b: any) => {
      const dateA = new Date(a.dateAdded).getTime();
      const dateB = new Date(b.dateAdded).getTime();
      return dateB - dateA;
    });

    const results = vulnerabilities.slice(0, limit).map((v: any): ExploitedVulnerability => ({
      cveId: v.cveID,
      vendorProject: v.vendorProject,
      product: v.product,
      vulnerabilityName: v.vulnerabilityName,
      dateAdded: v.dateAdded,
      shortDescription: v.shortDescription,
      requiredAction: v.requiredAction,
      dueDate: v.dueDate,
      notes: v.notes || '',
    }));

    return { vulnerabilities: results };
  } catch (error) {
    console.error('Error fetching CISA KEV catalog:', error);
    return { vulnerabilities: [] };
  }
}
